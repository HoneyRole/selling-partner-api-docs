# 出品パートナーAPIの使用プランとレート制限

APIの信頼性は、時間の経過とともに変化するアプリケーションのニーズを満たすための、容量とリソースのサイズに依存します。つまり、ピーク使用時のサービスが過負荷になることを防ぐために、使用状況を把握して予測し、リクエストの頻度を管理します。

出品パートナーAPIでは、リクエストは[トークンバケットアルゴリズム](https://en.wikipedia.org/wiki/Token_bucket)を使用してレート制限されます。このアルゴリズムは、トークンを含むバケットの類似性に基づいており、リクエスト生成で各トークンを交換することができます。トークンは、バケットの最大サイズに達するまで、設定された1秒あたりのレートを使用してバケットに自動的に追加されます。最大サイズは、バーストレートとも呼ばれます。リクエストごとに、バケットからトークンを減算します。バケットが空のためトークンを使用できないリクエストが生成されたときに、スロットルが発生します。スロットルされたリクエストは、エラー応答になります。

## 使用プラン

出品パートナーAPIオペレーションには、レート制限を指定する使用プランが関連付けられています。詳細については、APIリファレンスのドキュメントを参照してください。使用プランの定義は次のとおりです。

- Rate – トークンバケットに追加される1秒あたりのリクエスト数。これを使用して、スロットルを発生させずにリクエストを送信することができます。長期間の連続的な呼び出しを行っている場合、このレートを超えないようにすることで、スロットルされたリクエストを回避できます。

- Burst – トークンバケットの最大サイズ。これは、トークンバケットがいっぱいであると想定した場合、長期間生成して同時に送信できるリクエストの最大数も表しています。

## 動的使用プラン

この新しい機能は、時間の経過に伴うビジネスのニーズに基づいて、レート制限を自動的に調整します。

動的使用プランは、そのビジネスの現在および過去のビジネスニーズに基づいて、各出品パートナーに自動的に調整されるプランです。動的なレート制限調整を推進するためのルールとして、さまざまな手段が採用されています。つまり、動的使用プランを使用する出品パートナーAPIのオペレーションでは、レート制限の変更が予期されます。APIリファレンスのドキュメントで公開されているデフォルトのレートは、アプリケーション設計のたたき台として使用できます。ただし、動的使用プランの目的は時間の経過とともにこれらの制限を適正に調整することであるため、料金は変更されます。出品パートナーAPIのオペレーションにリクエストを送信すると、そのオペレーションの現在のレート制限がx-amzn-RateLimit-Limitレスポンスヘッダーに返されます。

## AmazonマーケットプレイスWebサービス（Amazon MWS）ドキュメント

動的使用プランは、Amazon MWSと比較してスロットルを減らすように設計されています。現在、Amazon MWSでは、ビジネス規模やビジネスニーズの変化を考慮することなく、レート制限が一律に適用されます。出品パートナーAPIの動的使用プランを使用すると、すべてのニーズに対応するワンサイズ設計から、ビジネスコンテキストと時間の経過に伴うニーズの変化に基づいて、各出品パートナーのレート制限における適切なサイズ化を重視するアプローチに移行できます。

主な改善のねらいは次のとおりです。

- 動的使用プランは、変化するビジネスニーズに応じてレート制限を調整します。レート制限は、各出品パートナーに対して設定されます。

- 動的使用プランは、トラフィックのパフォーマンス向上のために、自動的にレートを適正に調整します。

## よくあるご質問

### 一般

**アプリケーションでは、429応答をどのように処理する必要がありますか？**

429は、再試行可能なステータスコードです。再試行してください。ただし、スロットルされたリクエストを繰り返すには、バックオフ戦略が必要です。x-amzn-RateLimit-Limitヘッダーを参照して、レート制限が予期されたものかどうかを確認してください。

**使用プランに関してアプリケーションをテストするにはどうしたらよいですか？**

出品パートナーAPIテストサンドボックスは、本番稼働の使用プランを利用します。サンドボックスでは、本番環境と同じレート制限動作を見込むことができます。

**アプリケーションで、完全にスロットルを避けることができますか？**

いいえ。制御できない要因がいくつもあると、少数の一次的な429が発生する可能性があります。これが想定されるため、アプリケーションコードで考慮する必要があります。

**アプリケーションが常にスロットルされている場合はどうすればよいですか？**

アプリケーションが一貫してスロットルされている場合は、呼び出しパターンをさらに最適化できる可能性があります。例：

1. レート制限に合わせて、呼び出しの頻度を減らします。

2. ポーリングメカニズムよりもプッシュ通知を使用します。

3. 可能であれば、バッチAPIを使用します。

**私のユースケースでは、1オペレーションのレート制限が低すぎます。制限を増やすことはできますか？**

理想的には、効率的な呼び出しパターンが抑制されないような、適切なサイズ制限を目指しています。Amazonが適切に説明していないユースケースがあると思われる場合は、サポートチケットをオープンしてお知らせください。

**承認の取得が多くなると、アプリケーションでスロットルがより頻繁に発生しますか？**

いいえ。すべての使用プランはアプリケーション出品パートナーペアに固有であるため、スループットはクライアントとともに自然に増加します。

**レート制限は変更されますか？**

レート制限はいつでも上がる可能性があります。APIリファレンスドキュメントに記載されたレート制限が下がる場合は、変更を事前に通知し、変更が反映される前に、アプリケーションの更新とテストを行う時間を提供します。

動的使用プラン（後述）のレート制限は、ビジネスの状況に応じて自動的に調整されます。

### 動的使用プラン

**動的使用プランの全般的な目的は何ですか。**

今までの経緯から、同種の使用プランは、特定の状況では大きすぎ、他の状況では小さすぎることが観察されています。動的使用プランの目的は、特定の呼び出しにおけるよく知られたコンテキストを活用して、どのような状況でも適切な制限を設定することです。

**動的使用プランに影響する要因は何ですか？**

一般にレート制限は、出品パートナービジネスの種類、規模、および行動に基づいて形成されます。

**特定の使用プランに関連付けられている制限はどのくらいの頻度で変更されますか？**

制限の変更が、頻繁で破壊的にならないように目指しています。通常、制限は必要性があればすぐに変更されます。

**動的制限を順守するようにアプリケーションをコーディングするにはどうすればよいですか？**

ここでは、動的レート制限に関する優れたアプリケーション動作の提案をいくつか紹介します。

1. レート制限ヘッダーを読み取ります。

2. タイマーをハードコードしないでください。

3. ループ動作ではなく、イベントに対応するようコーディングします。こうすると、タイマーはまったく必要ありません。価格改定ツールの例では、n秒ごとではなく、価格通知に応じて価格を更新します。

**どの出品パートナーAPIセクションが、動的使用プランを使用していますか？**

注文の出品パートナーAPIです。

**すべてのオペレーションが動的使用プランをサポートしていないのはなぜですか？**

現在、取り組んでいるところです。
